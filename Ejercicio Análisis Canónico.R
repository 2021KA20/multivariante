
#_________ Analisis Canónico _______________


# Instalar paqueterías
library(tidyverse)

#-------------------------------
#   Preparación de la matriz
#-------------------------------

# Se utiliza la matriz penguins.xlsx
# Importar la matriz de datos.
library(readxl)
penguins <- read_excel("C:/Users/TOSHIBA/Downloads/penguins.xlsx")
View(penguins)

# Exploración de la matriz
dim(penguins)
colnames(penguins)
str(penguins)
anyNA(penguins)

# Escalamiento de la matriz
# Generación de variables X
X <- penguins %>% 
  select(grosor_pico_mm, largo_pico_mm) %>%
  scale()
head(X)

# Generación de variables Y
Y <- penguins %>%
  select(largo_aleta_mm,masa_corporal_g) %>%
  scale()
head(Y)

#----------------------------------
# Análisis canónico con un par de variables
#----------------------------------

# Librería y paquetería a utilizar
install.packages("CCA")
library(CCA)

# Análisis
ac<-cancor(X,Y)
ac

# Visualización de la matriz X
ac$xcoef

# Visualización de la matriz Y
ac$ycoef

# Visualización de la correlación canónica
ac$cor

# Obtención de la matriz de variables canónicas
# Se obtiene multiplicando los coeficientes por
# cada una de las variables (X1 y Y1)
ac1_X <- as.matrix(X) %*% ac$xcoef[, 1]
ac1_Y <- as.matrix(Y) %*% ac$ycoef[, 1]

#Visualización de los primeros 20 datos
ac1_X[1:20,]
ac1_Y[1:20,]


# Correlación canónica entre variable X1 y Y1
cor(ac1_X,ac1_Y)

# Verificación de la correlación canónica
assertthat::are_equal(ac$cor[1], 
                      cor(ac1_X,ac1_Y)[1])

#--------------------------
# Análisis canónico con dos pares de variables
#-----------------------------

# Cálculo de las variables X2 y Y2
ac2_X <- as.matrix(X) %*% ac$xcoef[, 2]
ac2_Y <- as.matrix(Y) %*% ac$ycoef[, 2]

# Agregamos las variables generadas a la matriz
# original de penguins

ac_df <- penguins %>% 
  mutate(ac1_X=ac1_X,
         ac1_Y=ac1_Y,
         ac2_X=ac2_X,
         ac2_Y=ac2_Y)

# Visualización de los nombres de las variables
colnames(ac_df)

# Generación del grafico scater plot para la
# visualización de X1 y Y1
ac_df %>% 
  ggplot(aes(x=ac1_X,y=ac1_Y))+
  geom_point(color="indianred1") +
  xlab("Grosor del pico (canónica)") +
  ylab("Largo de la aleta (canónica)") +
  ggtitle("Scater plot de X1 y Y1 canónicos")

# Generación de un boxplot
ac_df %>% 
  ggplot(aes(x=especie,y=ac1_X, color=especie))+
  geom_boxplot(width=0.5)+
  geom_jitter(width=0.15)+
  ggtitle("Variable Canónica X1 contra Especie")

# Interpretación: se observa una correlacion entre
# la variable canónica X1 y la variable latente Especie

ac_df %>% 
  ggplot(aes(x=especie,y=ac1_Y, color=especie))+
  geom_boxplot(width=0.5)+
  geom_jitter(width=0.15)+
  ggtitle("Variable Canónica Y1 contra Especie")

# Construcción de un scater plot con las variables
# X1 y Y1, separados por especie
ac_df %>% 
  ggplot(aes(x=ac1_X,y=ac1_Y, color=especie))+
  geom_point()+
  ggtitle("Variable Canónica X1 contra Y1")

# Scater plot con las variables canónicas
# X2 y Y2 separadas por género.

ac_df %>% 
  ggplot(aes(x=ac2_X,y=ac2_Y, color=genero))+
  geom_point()+
  ggtitle("Variable Canónica X2 contra Y2")

#Interpretación: No se identifica correlación
# entre el conjunto de variables X2 y Y2 separadas
# por género.


# Generar la ecuación canónica
ac$xcoef
ac$ycoef

View(ac_df)

#Sustitución en la ecuación canónica general
# U1 = 0.0309(grosor del pico) + 0.0461 (Largo del pico)
# V1 = -0.0552(Largo de la aleta) + 0.0014 (masa corporal)



